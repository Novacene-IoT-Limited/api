<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Novacene Viewer â€“ Sensor Status</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { font-size: 28px; }
    label { display: block; margin-top: 12px; }
    select, input[type="text"], input[type="datetime-local"] { margin-top: 6px; width: 100%; padding: 6px; }
    button { margin-top: 10px; padding: 10px; }
    #output { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>ðŸ“¡ Novacene Viewer â€“ Sensor Status (COâ‚‚, Temp, Humidity)</h1>

  <label for="apiToken">API Token:</label>
  <input type="text" id="apiToken">
  <label><input type="checkbox" id="rememberToken"> Remember Key</label>
  <button onclick="loadSitesAndZones()">Connect and Load Sites & Zones</button>

  <div id="selectors" style="display:none">
    <label for="siteSelect">Select Site:</label>
    <select id="siteSelect" onchange="loadZones()"></select>

    <label for="zoneSelect">Select Zone:</label>
    <select id="zoneSelect" onchange="loadDevices()"></select>

    <label for="sensorSelect">Select Sensor:</label>
    <select id="sensorSelect"></select>

    <label for="startDate">Start Date:</label>
    <input type="datetime-local" id="startDate">

    <label for="endDate">End Date:</label>
    <input type="datetime-local" id="endDate">

    <button onclick="fetchSensorData()">Fetch Sensor Data</button>
  </div>

  <h2>ðŸ“ˆ Sensor Data Output:</h2>
  <div id="output"></div>

  <script>
    const baseUrl = 'https://platform-api.novacene.io';

    window.onload = () => {
      const token = localStorage.getItem('apiToken');
      if (token) {
        document.getElementById('apiToken').value = token;
        document.getElementById('rememberToken').checked = true;
      }
    };

    function getToken() {
      const token = document.getElementById('apiToken').value.trim();
      if (document.getElementById('rememberToken').checked) {
        localStorage.setItem('apiToken', token);
      } else {
        localStorage.removeItem('apiToken');
      }
      return token;
    }

    async function loadSitesAndZones() {
      const token = getToken();
      const siteRes = await fetch(`${baseUrl}/sites`, {
        headers: { 'api_token': token }
      });
      const sites = await siteRes.json();

      const siteSelect = document.getElementById('siteSelect');
      siteSelect.innerHTML = sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

      document.getElementById('selectors').style.display = 'block';
      loadZones();
    }

    async function loadZones() {
      const token = getToken();
      const siteId = document.getElementById('siteSelect').value;
      const zoneRes = await fetch(`${baseUrl}/zones?siteids=${siteId}`, {
        headers: { 'api_token': token }
      });
      const zones = await zoneRes.json();

      const zoneSelect = document.getElementById('zoneSelect');
      zoneSelect.innerHTML = zones.map(z => `<option value="${z.id}">${z.name}</option>`).join('');

      loadDevices();
    }

    async function loadDevices() {
      const token = getToken();
      const zoneId = document.getElementById('zoneSelect').value;
      const url = `${baseUrl}/devices?zoneids=${zoneId}&limit=100&nodeveui=false&includeSensors=true&nocache=${Date.now()}`;
      const deviceRes = await fetch(url, {
        headers: { 'api_token': token }
      });
      const devices = await deviceRes.json();

      const sensors = [];
      devices.forEach(device => {
        (device.sensors || []).forEach(sensor => {
          sensors.push({ label: `${device.name} â€“ ${sensor.topic}`, token: sensor.token });
        });
      });

      const sensorSelect = document.getElementById('sensorSelect');
      sensorSelect.innerHTML = sensors.map(s => `<option value="${s.token}">${s.label}</option>`).join('');
    }

    async function fetchSensorData() {
      const token = getToken();
      const sensorToken = document.getElementById('sensorSelect').value;
      const from = new Date(document.getElementById('startDate').value).toISOString();
      const to = new Date(document.getElementById('endDate').value).toISOString();
      const url = `${baseUrl}/values?sensorToken=${sensorToken}&from=${from}&to=${to}`;
      const res = await fetch(url, { headers: { 'api_token': token } });
      const data = await res.json();

      document.getElementById('output').textContent = JSON.stringify(data, null, 2);
    }
  </script>
</body>
</html>
