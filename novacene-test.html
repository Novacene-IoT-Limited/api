<!DOCTYPE html>
<html>
<head>
  <title>Novacene Viewer â€“ Sensor Status</title>
</head>
<body>
  <h2>ðŸ“¡ Novacene Viewer â€“ Sensor Status (COâ‚‚, Temp, Humidity)</h2>

  <label>API Token:</label>
  <input type="text" id="apiToken" style="width: 400px;">
  <br>
  <label><input type="checkbox" id="rememberKey"> Remember Key</label>
  <br><br>

  <button onclick="connectAndLoad()">Connect and Load Sites & Zones</button>
  <br><br>

  <label>Site:</label>
  <select id="siteDropdown" onchange="loadZones()"></select>

  <label>Zone:</label>
  <select id="zoneDropdown"></select>

  <script>
    const apiBase = "https://platform-api.novacene.io";

    // Load saved key if checkbox was previously ticked
    window.onload = () => {
      const savedKey = localStorage.getItem('novacene_api_token');
      if (savedKey) {
        document.getElementById('apiToken').value = savedKey;
        document.getElementById('rememberKey').checked = true;
      }
    };

    function connectAndLoad() {
      const token = document.getElementById('apiToken').value.trim();

      if (document.getElementById('rememberKey').checked) {
        localStorage.setItem('novacene_api_token', token);
      }

      fetch(`${apiBase}/sites`, {
        headers: { 'api_token': token }
      })
      .then(res => res.json())
      .then(data => {
        const siteDropdown = document.getElementById('siteDropdown');
        siteDropdown.innerHTML = '';
        data.forEach(site => {
          const option = document.createElement('option');
          option.value = site.id;
          option.textContent = site.name;
          siteDropdown.appendChild(option);
        });
        // Load zones for first site automatically
        loadZones();
      })
      .catch(err => alert('Error loading sites: ' + err));
    }

    function loadZones() {
      const token = document.getElementById('apiToken').value.trim();
      const siteId = document.getElementById('siteDropdown').value;

      fetch(`${apiBase}/zones?siteids=${siteId}`, {
        headers: { 'api_token': token }
      })
      .then(res => res.json())
      .then(data => {
        const zoneDropdown = document.getElementById('zoneDropdown');
        zoneDropdown.innerHTML = '';
        data.forEach(zone => {
          const option = document.createElement('option');
          option.value = zone.id;
          option.textContent = zone.name;
          zoneDropdown.appendChild(option);
        });
      })
      .catch(err => alert('Error loading zones: ' + err));
    }
  </script>
</body>
</html>
