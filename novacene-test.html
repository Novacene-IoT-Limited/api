<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Novacene Sensor Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    input, button { margin: 0.5rem 0; padding: 0.5rem; }
    pre { background: #f0f0f0; padding: 1rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>📡 Novacene Viewer – Sensor Status (CO₂, Temp, Humidity)</h1>

  <label>API Token: <input type="text" id="apiToken" size="100" /></label><br />
  <label>Site ID: <input type="number" id="siteId" value="471" /></label><br />
  <label>Zone ID (Beer Fridge = 12651): <input type="number" id="zoneId" value="12651" /></label><br />
  <label>Sensor Token: <input type="text" id="sensorToken" size="60" placeholder="Sensor token for historical data" /></label><br />
  <label>From (YYYY-MM-DD): <input type="date" id="fromDate" /></label><br />
  <label>To (YYYY-MM-DD): <input type="date" id="toDate" /></label><br />

  <button onclick="fetchAllSensorData()">📅 Fetch Sensor History</button>

  <h2>Output</h2>
  <pre id="output">Waiting for input...</pre>

  <script>
    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function fetchSensorDataRange(sensorToken, fromDate, toDate) {
      const apiToken = document.getElementById("apiToken").value;
      const output = document.getElementById("output");
      let date = new Date(fromDate);
      const endDate = new Date(toDate);
      let allData = [];

      while (date <= endDate) {
        const dateString = date.toISOString().split("T")[0];
        const url = `https://api-prod.novacene.io/api/v2/devices/points-data?sensorToken=${sensorToken}&from=${dateString}T00:00:00.000Z&to=${dateString}T23:59:59.999Z&limit=1000`;

        try {
          const res = await fetch(url, {
            headers: { "accept": "application/json", "api_token": apiToken },
          });

          if (!res.ok) throw new Error(`Failed on ${dateString}: ${res.status}`);

          const data = await res.json();
          allData.push(...(data?.points || []));
        } catch (err) {
          output.textContent += `\n❌ ${err}`;
        }

        await delay(500); // respect rate limit (2 requests/sec)
        date.setDate(date.getDate() + 1);
      }

      return allData;
    }

    async function fetchAllSensorData() {
      const sensorToken = document.getElementById("sensorToken").value;
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      const output = document.getElementById("output");
      output.textContent = `⏳ Fetching historical data for ${sensorToken} from ${from} to ${to}...`;

      const data = await fetchSensorDataRange(sensorToken, from, to);

      output.textContent = `✅ Received ${data.length} points.\n\nSample:\n${JSON.stringify(data.slice(0, 5), null, 2)}`;
    }
  </script>
</body>
</html>
