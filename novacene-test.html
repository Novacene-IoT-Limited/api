<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üì° Novacene Viewer ‚Äì Sensor Status (CO‚ÇÇ, Temp, Humidity)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { width: 100%; padding: 6px; margin: 4px 0; }
    button { padding: 10px 20px; margin-top: 10px; }
    pre { background: #f6f6f6; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; max-height: 400px; overflow: auto; }
    h3 { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>üì° Novacene Viewer ‚Äì Sensor Status (CO‚ÇÇ, Temp, Humidity)</h1>

  <label><strong>API Token:</strong></label>
  <input type="text" id="apiToken" placeholder="Paste your API token here">

  <label><strong>Site ID:</strong></label>
  <input type="text" id="siteId" value="471">

  <label><strong>Zone ID (Beer Fridge = 12651):</strong></label>
  <input type="text" id="zoneId" value="12651">

  <label><strong>From Date (YYYY-MM-DD):</strong></label>
  <input type="text" id="fromDate" value="2025-03-01">

  <label><strong>To Date (YYYY-MM-DD):</strong></label>
  <input type="text" id="toDate" value="2025-03-25">

  <button onclick="runSteps()">Fetch Devices & Sensors</button>

  <h3>Step 1 ‚Äì Connect to Site</h3>
  <pre id="output1">Not started...</pre>

  <h3>Step 2 ‚Äì Get Zones</h3>
  <pre id="output2">Not started...</pre>

  <h3>Step 3 ‚Äì Get Devices</h3>
  <pre id="output3">Not started...</pre>

  <h3>Step 4 ‚Äì Sensor Metadata</h3>
  <pre id="output4">Not started...</pre>

  <h3>Step 5 ‚Äì Sensor History (from /points-data)</h3>
  <pre id="output5">Not started...</pre>

  <script>
    async function runSteps() {
      const token = document.getElementById('apiToken').value.trim();
      const siteId = document.getElementById('siteId').value.trim();
      const zoneId = document.getElementById('zoneId').value.trim();
      const from = document.getElementById('fromDate').value.trim();
      const to = document.getElementById('toDate').value.trim();

      const headers = {
        'accept': 'application/json',
        'Content-Type': 'application/json',
        'api_token': token
      };

      // Step 1: Confirm site connection
      document.getElementById('output1').textContent = 'üîÑ Fetching site data...';
      let siteResponse = await fetch(`https://api-prod.novacene.io/api/v2/sites/${siteId}`, { headers });
      let siteData = await siteResponse.json();
      document.getElementById('output1').textContent = JSON.stringify(siteData, null, 2);

      // Step 2: Get zones for site
      document.getElementById('output2').textContent = 'üîÑ Fetching zones...';
      let zoneRes = await fetch(`https://api-prod.novacene.io/api/v2/zones?siteid=${siteId}`, { headers });
      let zoneData = await zoneRes.json();
      document.getElementById('output2').textContent = JSON.stringify(zoneData.list, null, 2);

      // Step 3: Get devices in zone
      document.getElementById('output3').textContent = 'üîÑ Fetching devices...';
      let devRes = await fetch(`https://api-prod.novacene.io/api/v2/devices?page=1&limit=10000&siteid=${siteId}&zoneids=${zoneId}&includeSensors=true&nodeveui=false&nocache=${Date.now()}`, { headers });
      let devData = await devRes.json();
      document.getElementById('output3').textContent = JSON.stringify(devData, null, 2);

      // Step 4: Show sensors for devices
      const summary = [];
      const devices = devData?.devices || devData?.list || [];
      const sensorTokens = [];

      if (devices.length === 0) {
        document.getElementById('output4').textContent = '‚ö†Ô∏è No devices found in this zone.';
        return;
      }

      for (let d of devices) {
        summary.push(`üìü ${d.name} (ID: ${d.id})`);
        if (Array.isArray(d.sensors)) {
          for (let s of d.sensors) {
            sensorTokens.push(s.sensorToken);
            summary.push(`  - ${s.name} [${s.sensorToken}]`);
          }
        } else {
          summary.push('  ‚ö†Ô∏è No sensors found.');
        }
      }

      document.getElementById('output4').textContent = summary.join('\n');

      // Step 5: Fetch sensor history using points-data
      if (sensorTokens.length === 0) {
        document.getElementById('output5').textContent = '‚ö†Ô∏è No sensor tokens available for history lookup.';
        return;
      }

      document.getElementById('output5').textContent = 'üîÑ Fetching historical sensor data...';

      let postBody = {
        sensorTokens: sensorTokens,
        from: `${from}T00:00:00Z`,
        to: `${to}T23:59:59Z`,
        interval: "day"
      };

      try {
        const historyRes = await fetch(`https://api-prod.novacene.io/api/v2/devices/points-data`, {
          method: 'POST',
          headers,
          body: JSON.stringify(postBody)
        });

        const historyData = await historyRes.json();
        document.getElementById('output5').textContent = JSON.stringify(historyData, null, 2);
      } catch (err) {
        document.getElementById('output5').textContent = '‚ùå Failed to fetch sensor history. ' + err.message;
      }
    }
  </script>
</body>
</html>
