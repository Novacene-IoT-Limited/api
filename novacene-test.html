<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Beer Fridge Sensor Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input { width: 100%; margin-bottom: 10px; }
    button { padding: 10px 16px; }
    pre { background: #f4f4f4; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; max-height: 80vh; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>üç∫ Beer Fridge ‚Äì Device & Sensor Check</h2>

  <label><strong>API Token:</strong></label><br>
  <input type="text" id="apiToken" placeholder="Paste your API key"><br>

  <button onclick="fetchBeerFridge()">Fetch Sensors</button>

  <h3>Output</h3>
  <pre id="output">Waiting...</pre>

  <script>
    const zoneId = 12651;

    function getSensorStatus(type, value) {
      if (type === "co2") return value > 1000 ? "üî¥" : value > 800 ? "üü†" : "üü¢";
      if (type === "temperature") return value > 28 || value < 16 ? "üî¥" : value > 25 || value < 18 ? "üü†" : "üü¢";
      if (type === "humidity") return value > 70 || value < 30 ? "üî¥" : value > 60 || value < 40 ? "üü†" : "üü¢";
      return "N/A";
    }

    async function fetchBeerFridge() {
      const token = document.getElementById("apiToken").value.trim();
      const output = document.getElementById("output");
      output.textContent = "üîÑ Fetching devices from zone 12651 (Beer Fridge)...";

      const url = `https://api-prod.novacene.io/api/v2/devices?zoneids=${zoneId}&limit=10&nodeveui=false&includeSensors=true&nocache=${Date.now()}`;
      const headers = { "accept": "application/json", "api_token": token };

      try {
        const res = await fetch(url, { headers });
        const data = await res.json();

        if (!data?.list?.length) {
          output.textContent = "‚ö†Ô∏è No devices found in Beer Fridge zone.";
          return;
        }

        let result = `üì¶ Found ${data.list.length} device(s) in zone 12651:\n`;

        for (const device of data.list) {
          result += `\nüìü ${device.name} (ID: ${device.id})\n`;
          const sensors = device.sensors || [];

          const find = (key) => sensors.find(s => s.name?.toLowerCase().includes(key));
          const show = (label, key) => {
            const s = find(key);
            if (!s) {
              result += `  ‚Ä¢ ${label}: ‚ùå Not Found\n`;
              return;
            }
            const val = s.lastReceivedDataValue;
            const time = s.lastReceivedDataTime || s.lastReceivedData;
            const status = getSensorStatus(key, val);
            result += `  ‚Ä¢ ${label}: ${val} ${s.unit || ""} at ${time} ‚Üí ${status}\n`;
          };

          show("CO‚ÇÇ", "co2");
          show("Temperature", "temp");
          show("Humidity", "humid");
        }

        output.textContent = result;
      } catch (err) {
        output.textContent = "‚ùå Error: " + err.message;
      }
    }
  </script>
</body>
</html>
