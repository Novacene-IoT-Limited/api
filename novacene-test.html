<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Novacene Viewer ‚Äì Project 145</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    input[type="text"] { width: 80%; margin-bottom: 10px; }
    button { padding: 8px 16px; margin-top: 10px; }
    pre { background: #f7f7f7; padding: 10px; white-space: pre-wrap; max-height: 80vh; overflow-y: auto; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>üì° Novacene Viewer ‚Äì All Sites in Project 145</h1>

  <label><strong>API Token:</strong></label><br>
  <input type="text" id="apiToken" placeholder="Paste your API key here"><br>
  <label><input type="checkbox" id="rememberKey"> Remember API key</label><br><br>

  <label><strong>Date Range:</strong></label><br>
  <input type="date" id="startDate"> to <input type="date" id="endDate"><br>

  <button onclick="fetchData()">Fetch Data</button>

  <h3>Output</h3>
  <pre id="output">Waiting for input...</pre>

  <script>
    const projectId = 145;

    document.getElementById("startDate").value = new Date().toISOString().split('T')[0];
    document.getElementById("endDate").value = new Date().toISOString().split('T')[0];

    window.onload = () => {
      const savedKey = localStorage.getItem("novacene_api_key");
      if (savedKey) {
        document.getElementById("apiToken").value = savedKey;
        document.getElementById("rememberKey").checked = true;
      }
    };

    function getDateList(start, end) {
      const dates = [];
      let current = new Date(start);
      const last = new Date(end);
      while (current <= last) {
        dates.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
      }
      return dates;
    }

    async function fetchData() {
      const token = document.getElementById('apiToken').value.trim();
      const remember = document.getElementById('rememberKey').checked;
      if (remember) localStorage.setItem("novacene_api_key", token);
      else localStorage.removeItem("novacene_api_key");

      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const output = document.getElementById('output');
      const headers = { 'api_token': token };
      const dateList = getDateList(start, end);
      let outputText = `üì¶ Project ID: ${projectId}\n\n`;

      try {
        // Fetch all sites in this project
        const sitesRes = await fetch(`https://api-prod.novacene.io/api/v2/sites?projectid=${projectId}`, { headers });
        const sites = await sitesRes.json();

        if (!sites?.list?.length) {
          outputText += `‚ö†Ô∏è No sites found for this project.\n`;
          output.textContent = outputText;
          return;
        }

        for (const site of sites.list) {
          outputText += `üè¢ Site: ${site.name} (ID: ${site.id})\n`;

          // Fetch zones
          const zonesRes = await fetch(`https://api-prod.novacene.io/api/v2/zones?siteid=${site.id}`, { headers });
          const zones = await zonesRes.json();
          outputText += `  üåê Zones (${zones.list?.length || 0}):\n`;
          zones.list?.forEach(z => {
            outputText += `    - ${z.name} (ID: ${z.id}, Devices: ${z.devices})\n`;
          });

          // Fetch devices
          const devicesRes = await fetch(
            `https://api-prod.novacene.io/api/v2/devices?siteid=${site.id}&isRemoved=true`,
            { headers }
          );
          const devices = await devicesRes.json();

          if (!devices?.list?.length) {
            outputText += `  ‚ö†Ô∏è No devices found in this site.\n`;
            continue;
          }

          for (const d of devices.list) {
            outputText += `\n  üì° Device: ${d.name || "Unnamed"}\n`;
            outputText += `    ID: ${d.id}, Zone ID: ${d.zoneId || "‚ùì"}, deveui: ${d.deveui || "N/A"}\n`;

            const sensorIds = d.graphSettings?.sensorsOrder?.active || [];
            if (!sensorIds.length) {
              outputText += `    ‚ö†Ô∏è No active sensors\n`;
              continue;
            }

            outputText += `    Active Sensors:\n`;
            for (const sensorId of sensorIds) {
              outputText += `      Sensor ID: ${sensorId}\n`;

              for (const day of dateList) {
                const url = `https://api-prod.novacene.io/api/v2/devices/points-data?siteid=${site.id}&sensor=${sensorId}&start=${day}&end=${day}`;
                try {
                  const res = await fetch(url, { headers });
                  const json = await res.json();

                  if (json?.list?.length) {
                    outputText += `        üìÖ ${day} (${json.list.length} values):\n`;
                    json.list.forEach(pt => {
                      outputText += `          - ${pt.field || pt.key || "value"}: ${pt.value} at ${pt.time}\n`;
                    });
                  } else {
                    outputText += `        üìÖ ${day}: (no data)\n`;
                  }
                } catch (err) {
                  outputText += `        ‚ùå Error fetching data for ${day}\n`;
                }
              }
            }
          }
        }

        output.textContent = outputText;
      } catch (err) {
        output.textContent = `‚ùå Error: ${err.message}`;
        console.error(err);
      }
    }
  </script>
</body>
</html>
