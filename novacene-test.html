<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üì° Novacene Viewer ‚Äì Sensor Status (CO‚ÇÇ, Temp, Humidity)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { width: 100%; padding: 6px; margin: 4px 0; }
    button { padding: 10px 20px; margin-top: 10px; }
    pre { background: #f6f6f6; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; max-height: 400px; overflow: auto; }
    h3 { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>üì° Novacene Viewer ‚Äì Sensor Status (CO‚ÇÇ, Temp, Humidity)</h1>

  <label><strong>API Token:</strong></label>
  <input type="text" id="apiToken" placeholder="Paste your API token here">

  <label><strong>Site ID:</strong></label>
  <input type="text" id="siteId" value="471">

  <label><strong>Zone ID (Beer Fridge = 12651):</strong></label>
  <input type="text" id="zoneId" value="12651">

  <button onclick="runSteps()">Fetch Devices & Sensors</button>

  <h3>Step 1 ‚Äì Connect to Site</h3>
  <pre id="output1">Not started...</pre>

  <h3>Step 2 ‚Äì Get Zones</h3>
  <pre id="output2">Not started...</pre>

  <h3>Step 3 ‚Äì Get Devices</h3>
  <pre id="output3">Not started...</pre>

  <h3>Step 4 ‚Äì Sensor Data Summary</h3>
  <pre id="output4">Not started...</pre>

  <script>
    async function runSteps() {
      const token = document.getElementById('apiToken').value.trim();
      const siteId = document.getElementById('siteId').value.trim();
      const zoneId = document.getElementById('zoneId').value.trim();

      const headers = {
        'accept': 'application/json',
        'api_token': token
      };

      // Step 1: Confirm site connection
      document.getElementById('output1').textContent = 'üîÑ Fetching site data...';
      let siteResponse = await fetch(`https://api-prod.novacene.io/api/v2/sites/${siteId}`, { headers });
      let siteData = await siteResponse.json();
      document.getElementById('output1').textContent = JSON.stringify(siteData, null, 2);

      // Step 2: Get zones
      document.getElementById('output2').textContent = 'üîÑ Fetching zones...';
      let zoneRes = await fetch(`https://api-prod.novacene.io/api/v2/zones?siteid=${siteId}`, { headers });
      let zoneData = await zoneRes.json();
      document.getElementById('output2').textContent = JSON.stringify(zoneData.list, null, 2);

      // Step 3: Get devices in selected zone (limit capped to 200)
      document.getElementById('output3').textContent = 'üîÑ Fetching devices (limit 200)...';
      let devRes = await fetch(`https://api-prod.novacene.io/api/v2/devices?page=1&limit=200&siteid=${siteId}&zoneids=${zoneId}&includeSensors=true&nodeveui=false&nocache=${Date.now()}`, { headers });
      let devData = await devRes.json();
      document.getElementById('output3').textContent = JSON.stringify(devData, null, 2);

      // Step 4: Parse sensor data
      const summary = [];
      const devices = devData?.devices || devData?.list || [];

      if (devices.length === 200) {
        summary.push('‚ö†Ô∏è API limit of 200 devices reached. Results may be incomplete. Consider paging.');
      }

      if (devices.length === 0) {
        summary.push('‚ö†Ô∏è No devices found in this zone.');
      }

      for (let d of devices) {
        summary.push(`üìü ${d.name} (ID: ${d.id})`);
        if (Array.isArray(d.sensors)) {
          for (let s of d.sensors) {
            summary.push(`  - ${s.name}: ${s.lastReceivedDataValue} ${s.unit || ''} at ${s.lastReceivedDataTime || s.lastReceivedData}`);
          }
        } else {
          summary.push('  ‚ö†Ô∏è No sensors found.');
        }
      }

      document.getElementById('output4').textContent = summary.join('\n');
    }
  </script>
</body>
</html>
