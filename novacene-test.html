<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“¡ Novacene Viewer â€“ Sensor Status (COâ‚‚, Temp, Humidity)</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; background: #f4f4f4; }
    input, button, select { margin: 0.5rem 0; padding: 0.5rem; width: 100%; max-width: 600px; }
    #output { white-space: pre-wrap; background: white; padding: 1rem; margin-top: 1rem; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>ðŸ“¡ Novacene Viewer â€“ Sensor Status (COâ‚‚, Temp, Humidity)</h1>

  <label>API Token:</label>
  <input id="apiToken" placeholder="Enter your API token">

  <label>Site ID:</label>
  <input id="siteId" value="471">

  <label>Zone ID (Beer Fridge = 12651):</label>
  <input id="zoneId" value="12651">

  <button onclick="fetchAll()">Fetch Devices & Sensors</button>

  <hr>

  <label>Sensor Token (for history):</label>
  <input id="sensorToken" placeholder="e.g. 3f3fec49-7c23-4fef-903d-5b3fb9414403">

  <label>Date Range:</label>
  <input type="date" id="startDate"> to <input type="date" id="endDate">

  <button onclick="fetchSensorHistory()">Fetch Sensor History</button>

  <div id="output">Output...</div>

  <script>
    const apiBase = 'https://api-prod.novacene.io/api/v2';

    async function fetchAll() {
      const token = document.getElementById('apiToken').value.trim();
      const siteId = document.getElementById('siteId').value.trim();
      const zoneId = document.getElementById('zoneId').value.trim();
      const output = document.getElementById('output');

      output.textContent = 'Fetching site...';
      const site = await fetch(`${apiBase}/sites/${siteId}`, { headers: { 'api_token': token } }).then(res => res.json());

      output.textContent = `Step 1 â€“ Connect to Site\n\n${JSON.stringify(site, null, 2)}`;

      output.textContent += '\n\nStep 2 â€“ Get Zones...';
      const zones = await fetch(`${apiBase}/zones?siteid=${siteId}`, { headers: { 'api_token': token } }).then(res => res.json());

      output.textContent += `\n\n${JSON.stringify(zones, null, 2)}`;

      output.textContent += '\n\nStep 3 â€“ Get Devices...';
      const devices = await fetch(`${apiBase}/devices?page=1&limit=10000&siteid=${siteId}&zoneids=${zoneId}`, { headers: { 'api_token': token } }).then(res => res.json());

      output.textContent += `\n\n${JSON.stringify(devices, null, 2)}`;
    }

    async function fetchSensorHistory() {
      const token = document.getElementById('apiToken').value.trim();
      const sensorToken = document.getElementById('sensorToken').value.trim();
      const start = new Date(document.getElementById('startDate').value);
      const end = new Date(document.getElementById('endDate').value);
      const output = document.getElementById('output');

      if (!sensorToken || isNaN(start) || isNaN(end)) {
        return alert('Please fill all fields including sensor token and date range.');
      }

      output.textContent = 'Fetching sensor data...';

      const results = [];

      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const from = new Date(d);
        const to = new Date(d);
        to.setUTCHours(23, 59, 59, 999);

        const url = `${apiBase}/devices/points-data?sensorToken=${sensorToken}&from=${from.toISOString()}&to=${to.toISOString()}&groupBy=hour`;

        const res = await fetch(url, { headers: { 'api_token': token } }).then(r => r.json());

        results.push({ date: from.toISOString().split('T')[0], count: res.length, first: res[0]?.value });

        await new Promise(resolve => setTimeout(resolve, 600)); // API rate limit buffer
      }

      output.textContent = `\n\nðŸ“Š History for ${sensorToken} from ${start.toDateString()} to ${end.toDateString()}\n\n` + results.map(r => `${r.date}: count = ${r.count}, first value = ${r.first}`).join('\n');
    }
  </script>
</body>
</html>
