<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Novacene API Debug Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { width: 80%; margin-bottom: 10px; }
    button { padding: 8px 16px; margin-top: 10px; }
    pre { background: #f7f7f7; padding: 10px; white-space: pre-wrap; max-height: 80vh; overflow-y: scroll; }
  </style>
</head>
<body>

  <h1>Novacene API Viewer (Debug Mode)</h1>

  <label><strong>API Token:</strong></label><br>
  <input type="text" id="apiToken" placeholder="Paste your API key here"><br>

  <label><strong>Site ID:</strong></label><br>
  <input type="text" id="siteId" value="471"><br>

  <label><strong>Date Range:</strong></label><br>
  <input type="date" id="startDate">
  to
  <input type="date" id="endDate"><br>

  <button onclick="fetchData()">Fetch Data</button>

  <h3>Output</h3>
  <pre id="output">Waiting for input...</pre>

  <script>
    function getTodayDate() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    document.getElementById("startDate").value = getTodayDate();
    document.getElementById("endDate").value = getTodayDate();

    function getDateList(start, end) {
      const dates = [];
      let current = new Date(start);
      const last = new Date(end);

      while (current <= last) {
        dates.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
      }

      return dates;
    }

    async function fetchData() {
      const token = document.getElementById('apiToken').value.trim();
      const siteId = document.getElementById('siteId').value.trim();
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const headers = { 'api_token': token };
      const output = document.getElementById('output');
      output.textContent = "‚è≥ Fetching zones and devices...";

      try {
        const [zonesRes, devicesRes] = await Promise.all([
          fetch(`https://api-prod.novacene.io/api/v2/zones?siteid=${siteId}`, { headers }),
          fetch(`https://api-prod.novacene.io/api/v2/devices?siteid=${siteId}`, { headers }),
        ]);

        const zones = await zonesRes.json();
        const devices = await devicesRes.json();

        const zoneMap = {};
        zones.list?.forEach(z => zoneMap[z.id] = { ...z, children: [] });
        const rootZones = [];

        zones.list?.forEach(z => {
          if (z.parentId && zoneMap[z.parentId]) {
            zoneMap[z.parentId].children.push(zoneMap[z.id]);
          } else {
            rootZones.push(zoneMap[z.id]);
          }
        });

        function renderZoneTree(zones, indent = "") {
          return zones.map(z => {
            let str = `${indent}- ${z.name} (ID: ${z.id})\n`;
            if (z.children.length > 0) {
              str += renderZoneTree(z.children, indent + "  ");
            }
            return str;
          }).join("");
        }

        let outputText = `üìç Zones:\n${renderZoneTree(rootZones)}\n\nüì° Devices:\n`;
        const dateList = getDateList(start, end);

        for (const d of devices.list || []) {
          outputText += `\n\nüõ† DEBUG: Raw Device JSON:\n`;
outputText += JSON.stringify(d, null, 2) + "\n\n";
          outputText += `- Name: ${d.name || "Unnamed"}\n`;
          outputText += `  ID: ${d.id}\n`;
          outputText += `  Zone ID: ${d.zoneId || "N/A"}\n`;
          outputText += `  Device EUI: ${d.deveui || "N/A"}\n`;

          const sensorIds = d.graphSettings?.sensorsOrder?.active || [];
          outputText += `  Active Sensors: ${sensorIds.length} found\n`;
          outputText += `  Sensor IDs:\n`;

          if (sensorIds.length === 0) {
            outputText += `    (No active sensors)\n\n`;
            continue;
          }

          for (const sensorId of sensorIds) {
            outputText += `    - ${sensorId}\n`;
          }

          for (const sensorId of sensorIds) {
            for (const day of dateList) {
              const url = `https://api-prod.novacene.io/api/v2/devices/points-data?siteid=${siteId}&sensor=${sensorId}&start=${day}&end=${day}`;
              console.log(`üîç Fetching sensor ${sensorId} for ${day}`);
              console.log(`üì° URL: ${url}`);

              try {
                const pointRes = await fetch(url, { headers });
                const pointData = await pointRes.json();

                if (pointData?.list?.length) {
                  outputText += `    üìÖ ${day} (${pointData.list.length} values):\n`;
                  for (const point of pointData.list) {
                    const t = point.time || "";
                    const val = point.value;
                    const label = point.field || point.key || "value";
                    outputText += `      - ${label}: ${val} at ${t}\n`;
                  }
                } else {
                  outputText += `    üìÖ ${day}: No data\n`;
                }
              } catch (err) {
                outputText += `    ‚ùå Error fetching sensor ${sensorId} for ${day}\n`;
                console.error(err);
              }
            }
          }

          outputText += `\n`;
        }

        output.textContent = outputText;
      } catch (err) {
        output.textContent = `‚ùå Error: ${err.message}`;
        console.error(err);
      }
    }
  </script>
</body>
</html>
