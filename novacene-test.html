<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¡ Novacene Sensor Data Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    label { display: block; margin-top: 1em; }
    textarea { width: 100%; height: 300px; margin-top: 1em; font-family: monospace; }
  </style>
</head>
<body>
  <h2>ğŸ“¡ Novacene Viewer â€“ Sensor Status (COâ‚‚, Temp, Humidity)</h2>

  <label>
    API Token:
    <input type="text" id="apiToken" placeholder="Paste your API token here" style="width: 100%;">
  </label>

  <label>
    Site ID:
    <input type="text" id="siteId" placeholder="e.g. 471">
  </label>

  <label>
    Zone ID:
    <input type="text" id="zoneId" placeholder="e.g. 12651">
    <button onclick="fetchDevices()">Fetch Devices & Sensors</button>
  </label>

  <label>
    ğŸ“Š Available Sensors:
    <select id="sensorSelect" style="width: 100%;"></select>
  </label>

  <label>
    Start Date:
    <input type="datetime-local" id="startDate">
    End Date:
    <input type="datetime-local" id="endDate">
    <button onclick="fetchSensorData()">Fetch Sensor Data</button>
  </label>

  <label>
    ğŸ“ˆ Sensor Data Output:
    <textarea id="sensorDataOutput" readonly></textarea>
  </label>

  <script>
    async function fetchDevices() {
      const token = document.getElementById("apiToken").value;
      const zoneId = document.getElementById("zoneId").value;
      const sensorSelect = document.getElementById("sensorSelect");
      const output = document.getElementById("sensorDataOutput");

      output.value = "ğŸ”„ Fetching devices and sensors...";

      const url = `https://api.novacene.io/devices?zoneids=${zoneId}&limit=100&nodeveui=false&includeSensors=true&nocache=${Date.now()}`;

      try {
        const res = await fetch(url, {
          headers: {
            "api_token": token
          }
        });

        if (!res.ok) {
          output.value = `âŒ Error: ${res.status} ${res.statusText}`;
          return;
        }

        const data = await res.json();
        sensorSelect.innerHTML = "";

        if (!data.success || !data.data?.length) {
          output.value = "âš ï¸ No devices/sensors found.";
          return;
        }

        // Extract sensors
        for (const device of data.data) {
          if (!device.sensors) continue;
          for (const sensor of device.sensors) {
            const option = document.createElement("option");
            option.value = sensor.token;
            option.textContent = `${device.name} â€“ ${sensor.token}`;
            sensorSelect.appendChild(option);
          }
        }

        output.value = "âœ… Devices and sensors loaded.";

      } catch (err) {
        output.value = `âŒ Fetch failed: ${err.message}`;
      }
    }

    async function fetchSensorData() {
      const token = document.getElementById("apiToken").value;
      const sensorToken = document.getElementById("sensorSelect").value;
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const output = document.getElementById("sensorDataOutput");

      if (!sensorToken || !start || !end) {
        output.value = "âš ï¸ Please select a sensor and date range.";
        return;
      }

      output.value = "ğŸ”„ Fetching sensor data...";

      const url = `https://api.novacene.io/points-data?sensortoken=${encodeURIComponent(sensorToken)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;

      try {
        const res = await fetch(url, {
          headers: {
            "api_token": token
          }
        });

        if (!res.ok) {
          output.value = `âŒ Error: ${res.status} ${res.statusText}`;
          return;
        }

        const data = await res.json();

        if (!data.success || !data.data?.values?.length) {
          output.value = "âš ï¸ No data found for selected range.";
          return;
        }

        const formatted = data.data.values.map(v => `${v.timestamp} â†’ ${v.value}`).join("\n");
        output.value = `âœ… Sensor Data:\n${formatted}`;

      } catch (err) {
        output.value = `âŒ Error fetching data: ${err.message}`;
      }
    }
  </script>
</body>
</html>
