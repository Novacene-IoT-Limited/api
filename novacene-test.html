<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ“¡ Novacene Viewer â€“ Sensor Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    select, input, button, textarea { margin-top: 5px; width: 100%; padding: 6px; }
    .section { margin-top: 30px; }
    .inline { display: inline-block; width: auto; margin-right: 10px; }
  </style>
</head>
<body>
  <h2>ðŸ“¡ Novacene Viewer â€“ Sensor Dashboard</h2>

  <div class="section">
    <label>API Token:</label>
    <input type="text" id="apiToken" placeholder="Enter your API token" />
    <input type="checkbox" id="rememberKey" /> Remember API Token
  </div>

  <div class="section">
    <label>Project ID:</label>
    <input type="text" id="projectId" placeholder="Enter Project ID (e.g. 471)" />

    <label>Site:</label>
    <select id="siteSelect"></select>

    <label>Zone:</label>
    <select id="zoneSelect"></select>

    <button onclick="fetchDevicesAndSensors()">Fetch Devices & Sensors</button>
  </div>

  <div id="deviceList" class="section"></div>

  <div class="section">
    <label>ðŸ“Š Available Sensors:</label>
    <select id="sensorSelect"></select>

    <label>Start Date:</label>
    <input type="datetime-local" id="startDate" />
    <label>End Date:</label>
    <input type="datetime-local" id="endDate" />

    <button onclick="fetchSensorData()">Fetch Sensor Data</button>
  </div>

  <div class="section">
    <label>ðŸ“ˆ Sensor Data Output:</label>
    <textarea id="sensorDataOutput" rows="10"></textarea>
  </div>

  <script>
    const apiBase = 'https://api.novacene.io';

    window.onload = () => {
      if (localStorage.getItem('apiToken')) {
        document.getElementById('apiToken').value = localStorage.getItem('apiToken');
        document.getElementById('rememberKey').checked = true;
      }
    }

    async function fetchSites() {
      const token = document.getElementById('apiToken').value;
      if (!token) return alert('API Token required');
      const res = await fetch(`${apiBase}/site`, {
        headers: { 'api_token': token }
      });
      const sites = await res.json();
      const siteSelect = document.getElementById('siteSelect');
      siteSelect.innerHTML = '';
      sites.forEach(site => {
        const opt = document.createElement('option');
        opt.value = site.id;
        opt.textContent = site.name;
        siteSelect.appendChild(opt);
      });
      fetchZones();
    }

    async function fetchZones() {
      const token = document.getElementById('apiToken').value;
      const siteId = document.getElementById('siteSelect').value;
      if (!token || !siteId) return;
      const res = await fetch(`${apiBase}/zones?siteids=${siteId}`, {
        headers: { 'api_token': token }
      });
      const zones = await res.json();
      const zoneSelect = document.getElementById('zoneSelect');
      zoneSelect.innerHTML = '';
      zones.forEach(zone => {
        const opt = document.createElement('option');
        opt.value = zone.id;
        opt.textContent = zone.name;
        zoneSelect.appendChild(opt);
      });
    }

    async function fetchDevicesAndSensors() {
      const token = document.getElementById('apiToken').value;
      const zoneId = document.getElementById('zoneSelect').value;
      if (!token || !zoneId) return;

      if (document.getElementById('rememberKey').checked) {
        localStorage.setItem('apiToken', token);
      } else {
        localStorage.removeItem('apiToken');
      }

      const res = await fetch(`${apiBase}/devices?zoneids=${zoneId}&limit=100&nodeveui=false&includeSensors=true&nocache=${Date.now()}`, {
        headers: { 'api_token': token }
      });
      const devices = await res.json();
      const outputDiv = document.getElementById('deviceList');
      const sensorSelect = document.getElementById('sensorSelect');
      outputDiv.innerHTML = '';
      sensorSelect.innerHTML = '';

      devices.forEach(device => {
        const d = document.createElement('div');
        d.innerHTML = `<strong>ðŸ“Ÿ ${device.name}</strong> (ID: ${device.id})`;
        outputDiv.appendChild(d);
        if (device.sensors) {
          device.sensors.forEach(sensor => {
            const s = document.createElement('div');
            s.textContent = `ðŸ”¹ ${sensor.token}: ${sensor.last_value} @ ${sensor.timestamp}`;
            outputDiv.appendChild(s);
            const opt = document.createElement('option');
            opt.value = sensor.token;
            opt.textContent = `${device.name} â€“ ${sensor.token}`;
            sensorSelect.appendChild(opt);
          });
        }
      });
    }

    async function fetchSensorData() {
      const token = document.getElementById('apiToken').value;
      const sensorToken = document.getElementById('sensorSelect').value;
      const start = new Date(document.getElementById('startDate').value).toISOString();
      const end = new Date(document.getElementById('endDate').value).toISOString();
      const output = document.getElementById('sensorDataOutput');
      output.value = 'Loading...';

      const res = await fetch(`${apiBase}/sensordata?sensor=${sensorToken}&start=${start}&end=${end}`, {
        headers: { 'api_token': token }
      });
      const data = await res.json();
      output.value = JSON.stringify(data, null, 2);
    }

    document.getElementById('siteSelect').addEventListener('change', fetchZones);
    document.getElementById('apiToken').addEventListener('change', fetchSites);
  </script>
</body>
</html>
