<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Novacene Sensor Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    textarea { width: 100%; height: 200px; }
    select, input { margin: 0.5em 0; width: 100%; }
    .section-title { font-size: 1.3em; margin-top: 1em; font-weight: bold; }
  </style>
</head>
<body>

<h2>ğŸ“¡ Novacene Viewer â€“ Sensor Status (COâ‚‚, Temp, Humidity)</h2>

<label>API Token:</label><br/>
<input type="text" id="apiToken" placeholder="Your API token"/><br/>

<label>Site ID:</label><br/>
<input type="text" id="siteId" placeholder="e.g. 471"/><br/>

<label>Zone ID:</label><br/>
<input type="text" id="zoneId" placeholder="e.g. 12651"/><br/>

<button onclick="fetchDevices()">Fetch Devices & Sensors</button>

<div class="section-title">ğŸ“Š Available Sensors:</div>
<label>Select Sensor:</label>
<select id="sensorSelect"></select>

<label>Start Date:</label>
<input type="datetime-local" id="startDate">

<label>End Date:</label>
<input type="datetime-local" id="endDate">

<button onclick="fetchSensorData()">Fetch Sensor Data</button>

<div class="section-title">ğŸ“ˆ Sensor Data Output:</div>
<textarea id="sensorOutput" readonly></textarea>

<script>
let sensors = [];

async function fetchDevices() {
  const token = document.getElementById("apiToken").value;
  const zoneId = document.getElementById("zoneId").value;

  const url = `https://api.novacene.io/api/devices?zoneids=${zoneId}&limit=100&nodeveui=false&includeSensors=true&nocache=${Date.now()}`;
  const res = await fetch(url, {
    headers: { "api_token": token }
  });

  const data = await res.json();
  console.log("Fetched device data:", data);

  if (!data.success) {
    alert("Error fetching devices: " + JSON.stringify(data));
    return;
  }

  sensors = [];

  const select = document.getElementById("sensorSelect");
  select.innerHTML = "";

  data.data.forEach(device => {
    device.sensors?.forEach(sensor => {
      sensors.push(sensor);
      const opt = document.createElement("option");
      opt.value = sensor.token;
      opt.textContent = `${device.name} â€“ ${sensor.token}`;
      select.appendChild(opt);
    });
  });

  console.log("Loaded sensors:", sensors);
}

async function fetchSensorData() {
  const token = document.getElementById("apiToken").value;
  const sensorToken = document.getElementById("sensorSelect").value;
  const startRaw = document.getElementById("startDate").value;
  const endRaw = document.getElementById("endDate").value;
  const output = document.getElementById("sensorOutput");

  if (!sensorToken || !startRaw || !endRaw) {
    alert("Please select a sensor and date range.");
    return;
  }

  const start = startRaw + ":00Z";
  const end = endRaw + ":00Z";

  const url = `https://api.novacene.io/api/sensordata?token=${encodeURIComponent(sensorToken)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&limit=1000`;

  console.log("Sensor data URL:", url);

  try {
    const res = await fetch(url, {
      headers: { "api_token": token }
    });

    const data = await res.json();
    console.log("Sensor data response:", data);

    if (!data.success) {
      output.value = "âŒ API Error:\n" + JSON.stringify(data, null, 2);
      return;
    }

    if (!data.data?.values?.length) {
      output.value = "âš ï¸ No data found for that time range.";
      return;
    }

    const rows = data.data.values.map(entry =>
      `${entry.timestamp} â†’ ${entry.value}`
    );

    output.value = rows.join("\n");
  } catch (err) {
    output.value = "âŒ Fetch error:\n" + err.message;
  }
}
</script>
</body>
</html>
