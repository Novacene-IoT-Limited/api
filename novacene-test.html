<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Novacene Device Sensor Test</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input[type="text"] { width: 100%; margin-bottom: 10px; }
    pre { background: #f0f0f0; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>üì° Novacene Sensor Test: Beer Fridge</h2>

  <label><strong>API Token:</strong></label><br>
  <input type="text" id="apiToken" placeholder="Paste your API key here"><br>

  <button onclick="fetchSensors()">Fetch Sensors & Data</button>

  <h3>Output:</h3>
  <pre id="output">Waiting...</pre>

  <script>
    const deveui = "24E124785E289576";
    const siteid = 471;

    function getToday() {
      return new Date().toISOString().split("T")[0];
    }

    async function fetchSensors() {
      const token = document.getElementById("apiToken").value.trim();
      const output = document.getElementById("output");
      const headers = { "api_token": token };

      output.textContent = "üîÑ Fetching sensors for device " + deveui + "...";

      try {
        // Get sensors by DevEUI
        const res = await fetch(`https://api-prod.novacene.io/api/v2/devices/sensors-data?deveui=${deveui}`, { headers });
        const data = await res.json();

        if (!Array.isArray(data) || !data.length) {
          output.textContent = "‚ö†Ô∏è No sensors found for this device.";
          return;
        }

        output.textContent = `‚úÖ Found ${data.length} sensor(s):\n`;

        const today = getToday();
        for (const sensor of data) {
          output.textContent += `\nüìè ${sensor.name} (${sensor.unit || "?"})\n`;

          const url = `https://api-prod.novacene.io/api/v2/devices/points-data?siteid=${siteid}&sensor=${sensor.sensorToken}&start=${today}&end=${today}`;
          try {
            const res2 = await fetch(url, { headers });
            const sensorData = await res2.json();

            if (sensorData?.list?.length) {
              for (const pt of sensorData.list) {
                output.textContent += `  ‚Ä¢ ${pt.value} at ${pt.time}\n`;
              }
            } else {
              output.textContent += `  ‚ö†Ô∏è No data found for today.\n`;
            }
          } catch (err2) {
            output.textContent += `  ‚ùå Failed to get data for sensor ${sensor.sensorToken}\n`;
          }
        }
      } catch (err) {
        output.textContent = "‚ùå Error fetching sensors: " + err.message;
      }
    }
  </script>
</body>
</html>
