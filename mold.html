<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mould Risk Dashboard (Demo)</title>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- pdfmake for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake/build/vfs_fonts.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    header { background: #f2f2f2; padding: 1rem; }
    .cards { display: flex; gap: 1rem; margin: 1rem; }
    .card { background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1; text-align: center; }
    h2 { margin: 0.5rem 0; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: left; }
    .btns { margin: 1rem; }
    .btns button { margin-right: 0.5rem; padding: 0.5rem 1rem; }
    #chartContainer { margin: 1rem; }
  </style>
</head>
<body>

<header>
  <h1>Mould Risk Dashboard (Fetching from Google Sheets)</h1>
</header>

<!-- Top-level summary cards -->
<div class="cards">
  <div class="card">
    <h2>Records Found</h2>
    <p id="recordsCount">0</p>
  </div>
</div>

<!-- Data table -->
<div style="margin: 1rem;">
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Temperature (째C)</th>
      </tr>
    </thead>
    <tbody id="zoneTableBody">
      <!-- Populated dynamically from CSV -->
    </tbody>
  </table>
</div>

<!-- Chart container -->
<div id="chartContainer">
  <canvas id="rhChart"></canvas>
</div>

<!-- Buttons for exporting -->
<div class="btns">
  <button id="downloadCsv">Export CSV</button>
  <button id="downloadPdf">Export PDF</button>
</div>

<script>
// --------------------------------------------------------------------
// 1) REPLACE with your published Google Sheet CSV link
// (Ensure your sheet has a column for timestamp and a column containing the word "temperature")
// --------------------------------------------------------------------
const GOOGLE_SHEET_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTtyaaD9UIdtuhO9BW1q6Mb4-26_jsidDU73HB1DE4Y8FE1tKSQxIAkLasrc3bT-0mvDy4ejjgTPJm1/pub?gid=0&single=true&output=csv';

// We'll store parsed rows in an array
let tableData = [];

// Columns we expect: e.g. "Timestamp" and some "temperature" column
let indexTimestamp = -1;
let indexTemperature = -1;

// 2) FETCH CSV from Google Sheets
fetch(GOOGLE_SHEET_CSV_URL)
  .then(response => response.text())
  .then(csv => {
    parseCsv(csv);
    updateDashboard();
    buildTable();
    buildChart();
  })
  .catch(err => console.error('Error fetching CSV:', err));

// 3) PARSE CSV
function parseCsv(csv) {
  // Split lines
  const lines = csv.split('\\n').filter(line => line.trim().length > 0);
  if (!lines.length) return;

  // First line: headers
  const headers = lines[0].split(',');

  // Identify which columns hold "Timestamp" and "temperature"
  // We'll do a naive case-insensitive match on the header text.
  headers.forEach((hdr, idx) => {
    const lowerHdr = hdr.toLowerCase();
    if (lowerHdr.includes('timestamp')) {
      indexTimestamp = idx;
    }
    if (lowerHdr.includes('temperature')) {
      indexTemperature = idx;
    }
  });

  // If either index not found, we won't parse further
  if (indexTimestamp === -1 || indexTemperature === -1) {
    console.warn('Could not find expected columns. Check your CSV headers.');
    return;
  }

  // Subsequent lines: data
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i].split(',');
    if (row.length !== headers.length) continue;

    const ts = row[indexTimestamp];
    const tempStr = row[indexTemperature];
    // Convert temperature to float if possible
    const tempVal = parseFloat(tempStr);

    // We store each row as an object
    tableData.push({ timestamp: ts, temperature: tempVal });
  }
}

// 4) UPDATE DASHBOARD COUNTERS
function updateDashboard() {
  document.getElementById('recordsCount').innerText = tableData.length;
}

// 5) BUILD TABLE
function buildTable() {
  const tbody = document.getElementById('zoneTableBody');
  tbody.innerHTML = ''; // clear existing

  tableData.forEach(item => {
    const tr = document.createElement('tr');

    const tdTime = document.createElement('td');
    tdTime.textContent = item.timestamp;
    tr.appendChild(tdTime);

    const tdTemp = document.createElement('td');
    tdTemp.textContent = item.temperature ? item.temperature.toFixed(1) : 'N/A';
    tr.appendChild(tdTemp);

    tbody.appendChild(tr);
  });
}

// 6) BUILD CHART
function buildChart() {
  // We'll just plot temperature over time
  // For the chart labels, let's use the raw timestamps
  const chartLabels = tableData.map(d => d.timestamp);
  const tempData = tableData.map(d => d.temperature);

  const chartCtx = document.getElementById('rhChart').getContext('2d');
  const chartData = {
    labels: chartLabels,
    datasets: [
      {
        label: 'Temperature (째C)',
        data: tempData,
        borderColor: 'blue',
        backgroundColor: 'blue',
        type: 'line'
      }
    ]
  };
  const chartConfig = {
    type: 'line', // overall type, though our dataset also specifies 'line'
    data: chartData,
    options: {
      responsive: true,
      scales: {
        y: {
          title: {
            display: true,
            text: 'Temperature (째C)'
          }
        }
      }
    }
  };
  new Chart(chartCtx, chartConfig);
}

// 7) EXPORT CSV
document.getElementById('downloadCsv').addEventListener('click', () => {
  // Rebuild CSV from tableData
  const rows = [['Timestamp','Temperature']];
  tableData.forEach(item => {
    rows.push([item.timestamp, String(item.temperature)]);
  });
  let csvContent = '';
  rows.forEach(row => {
    csvContent += row.join(',') + '\\n';
  });
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', 'DashboardData.csv');
  link.click();
});

// 8) EXPORT PDF
document.getElementById('downloadPdf').addEventListener('click', () => {
  // Construct a pdfmake table body
  const bodyRows = [
    ['Timestamp','Temperature (째C)']
  ];
  tableData.forEach(item => {
    bodyRows.push([ item.timestamp, item.temperature ? String(item.temperature.toFixed(1)) : 'N/A' ]);
  });
  const docDefinition = {
    content: [
      { text: 'Mould Risk Report (Temperature Only)', style: 'header' },
      '',
      {
        table: {
          body: bodyRows
        }
      }
    ],
    styles: {
      header: { fontSize: 16, bold: true }
    }
  };
  pdfMake.createPdf(docDefinition).download('DashboardReport.pdf');
});
</script>

</body>
</html>
