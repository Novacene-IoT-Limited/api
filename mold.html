<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mould Risk Scatter Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
    }
    header {
      background: #f2f2f2; padding: 1rem;
      border-bottom: 1px solid #ccc;
    }
    h1 { margin: 0; }
    .container {
      max-width: 900px;
      margin: 1rem auto; padding: 1rem;
    }
    canvas {
      width: 100%; height: 400px;
    }
    .legend {
      display: flex; gap: 1rem; margin-top: 0.5rem;
    }
    .legend-item {
      display: flex; align-items: center; gap: 0.25rem;
    }
    .legend-color {
      width: 1rem; height: 1rem; border-radius: 50%;
    }
    .legend-color.green { background: green; }
    .legend-color.amber { background: orange; }
    .legend-color.red   { background: red; }
  </style>
</head>
<body>

<header>
  <h1>Damp & Mould Risk at a Glance</h1>
</header>

<div class="container">
  <canvas id="scatterChart"></canvas>
  <div class="legend">
    <div class="legend-item"><div class="legend-color green"></div> Normal</div>
    <div class="legend-item"><div class="legend-color amber"></div> Caution</div>
    <div class="legend-item"><div class="legend-color red"></div> High Risk</div>
  </div>
</div>

<script>
// ----------------------------------------------------------------------
// 1) URL to your 24-hour CSV (the one with 144 rows) 
//    e.g. "mold_risk_24hr.csv" if hosted locally or a published link 
//    If you have a Google Sheets CSV link, place that URL here:
const CSV_URL = 'mold_risk_24hr.csv';

// 2) Column names we’ll parse from the CSV
//    - "Timestamp" (x-axis label)
//    - "Temp_004" (plotted on y-axis) - adjust if you want a different sensor
//    - "RH_004"   (to determine color) 
const TIMESTAMP_COL = 'Timestamp';
const TEMPERATURE_COL = 'Temp_004';
const HUMIDITY_COL = 'RH_004';

// 3) Threshold logic for humidity => color
function getColorByHumidity(hum) {
  if (hum < 60) return 'green';
  if (hum < 70) return 'orange';
  return 'red';
}

// 4) Parse the date/time from CSV. We'll store as a JS date for the x-axis.
function parseTimestamp(tsString) {
  // e.g. "2025-03-26 00:00"
  // Return a Date object
  return new Date(tsString.replace(' ', 'T')); 
  // Alternatively, adjust if needed for your local time zone
}

// We'll store the data points in an array
let chartDataPoints = [];

// Fetch the CSV
fetch(CSV_URL)
  .then(response => response.text())
  .then(csv => {
    parseCsv(csv);
    buildChart();
  })
  .catch(err => console.error('Error loading CSV:', err));

// Parse CSV
function parseCsv(csv) {
  const lines = csv.split('\n').filter(line => line.trim() !== '');
  if (!lines.length) return;

  const headers = lines[0].split(',');
  // Identify column indices
  const tsIndex = headers.indexOf(TIMESTAMP_COL);
  const tempIndex = headers.indexOf(TEMPERATURE_COL);
  const humIndex = headers.indexOf(HUMIDITY_COL);

  if (tsIndex === -1 || tempIndex === -1 || humIndex === -1) {
    console.warn('Check your CSV headers. Could not find the needed columns.');
    return;
  }

  // For each data row
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i].split(',');
    if (row.length < headers.length) continue;

    const tsStr = row[tsIndex];
    const tempStr = row[tempIndex];
    const humStr = row[humIndex];

    const tempVal = parseFloat(tempStr);
    const humVal = parseFloat(humStr);

    if (isNaN(tempVal) || isNaN(humVal)) continue;

    const dateObj = parseTimestamp(tsStr);

    // We'll create a scatter point with x=Date, y=Temperature
    // color depends on humidity
    chartDataPoints.push({
      x: dateObj,
      y: tempVal,
      humidity: humVal
    });
  }
}

// Build Chart
function buildChart() {
  const ctx = document.getElementById('scatterChart').getContext('2d');

  // We'll create a single dataset for the scatter,
  // coloring each point individually based on humidity
  const scatterData = chartDataPoints.map(point => {
    return {
      x: point.x,        // Date object for time scale
      y: point.y,        // Temperature
      backgroundColor: getColorByHumidity(point.humidity),
      radius: 4          // size of the dot
    };
  });

  new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Temperature',
          data: scatterData,
          parsing: false,  // we'll supply {x, y} directly
          pointBackgroundColor: scatterData.map(d => d.backgroundColor),
          showLine: false
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: 'time',
          time: {
            displayFormats: {
              hour: 'HH:mm'
            },
            tooltipFormat: 'EEE, dd MMM HH:mm'
          },
          title: {
            display: true,
            text: 'Time'
          }
        },
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: 'Temperature (°C)'
          },
          suggestedMin: 5,  // adjust if you want lower bound 
          suggestedMax: 25  // or higher if data goes beyond 25
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const raw = context.raw;
              const tempVal = raw.y;
              // We stored the backgroundColor on the raw as well,
              // but for humidity we need to cross-reference chartDataPoints
              // The easiest way is to find the matching point:
              const match = chartDataPoints[context.dataIndex];
              const hum = match?.humidity ?? 'N/A';
              return `Temp: ${tempVal} °C, RH: ${hum}%`;
            }
          }
        }
      }
    }
  });
}
</script>

</body>
</html>
