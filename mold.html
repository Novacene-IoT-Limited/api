<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mould Risk Dashboard (Static Test)</title>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- pdfmake for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake/build/vfs_fonts.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    header { background: #f2f2f2; padding: 1rem; }
    .cards { display: flex; gap: 1rem; margin: 1rem; }
    .card { background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1; text-align: center; }
    h2 { margin: 0.5rem 0; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: left; }
    .btns { margin: 1rem; }
    .btns button { margin-right: 0.5rem; padding: 0.5rem 1rem; }
    #chartContainer { margin: 1rem; }
  </style>
</head>
<body>

<header>
  <h1>Mould Risk Dashboard</h1>
</header>

<!-- Top-level summary cards -->
<div class="cards">
  <div class="card">
    <h2>Buildings</h2>
    <p id="bldCount">0</p>
  </div>
  <div class="card">
    <h2>Zones Monitored</h2>
    <p id="zoneCount">0</p>
  </div>
  <div class="card">
    <h2>Zones High Risk</h2>
    <p id="highRiskCount">0</p>
  </div>
  <div class="card">
    <h2>Zones Caution</h2>
    <p id="cautionCount">0</p>
  </div>
  <div class="card">
    <h2>Zones Normal</h2>
    <p id="normalCount">0</p>
  </div>
</div>

<!-- Data table -->
<div style="margin: 1rem;">
  <table>
    <thead>
      <tr>
        <th>Building</th>
        <th>Zone</th>
        <th>Temperature (°C)</th>
        <th>Humidity (%)</th>
        <th>Risk Score</th>
        <th>Time in High RH</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="zoneTableBody">
      <!-- Populated dynamically from the static JS data below -->
    </tbody>
  </table>
</div>

<!-- Chart container -->
<div id="chartContainer">
  <canvas id="rhChart"></canvas>
</div>

<!-- Buttons for exporting -->
<div class="btns">
  <button id="downloadCsv">Export CSV</button>
  <button id="downloadPdf">Export PDF</button>
</div>

<script>
// A week of mock data for 3 rooms (7 entries each = 21 total rows)
// Each row: building, zone, temperature, humidity, riskScore, timeHighRH, status
const tableData = [
  // Room 101 (7 days)
  { building:'A', zone:'Room 101', temperature:19.2, humidity:58, riskScore:2, timeHighRH:'0h/24h', status:'Low' },
  { building:'A', zone:'Room 101', temperature:19.5, humidity:64, riskScore:3, timeHighRH:'2h/24h', status:'Medium' },
  { building:'A', zone:'Room 101', temperature:20.1, humidity:70, riskScore:5, timeHighRH:'3h/24h', status:'Medium' },
  { building:'A', zone:'Room 101', temperature:20.2, humidity:75, riskScore:7, timeHighRH:'5h/24h', status:'High' },
  { building:'A', zone:'Room 101', temperature:19.8, humidity:72, riskScore:6, timeHighRH:'4h/24h', status:'High' },
  { building:'A', zone:'Room 101', temperature:18.5, humidity:68, riskScore:4, timeHighRH:'2h/24h', status:'Medium' },
  { building:'A', zone:'Room 101', temperature:20.0, humidity:60, riskScore:2, timeHighRH:'1h/24h', status:'Low' },

  // Room 102 (7 days)
  { building:'A', zone:'Room 102', temperature:19.0, humidity:55, riskScore:1, timeHighRH:'0h/24h', status:'Low' },
  { building:'A', zone:'Room 102', temperature:19.1, humidity:60, riskScore:2, timeHighRH:'1h/24h', status:'Low' },
  { building:'A', zone:'Room 102', temperature:19.7, humidity:66, riskScore:4, timeHighRH:'2h/24h', status:'Medium' },
  { building:'A', zone:'Room 102', temperature:20.3, humidity:72, riskScore:6, timeHighRH:'4h/24h', status:'High' },
  { building:'A', zone:'Room 102', temperature:20.5, humidity:75, riskScore:8, timeHighRH:'5h/24h', status:'High' },
  { building:'A', zone:'Room 102', temperature:20.0, humidity:70, riskScore:5, timeHighRH:'3h/24h', status:'Medium' },
  { building:'A', zone:'Room 102', temperature:18.9, humidity:63, riskScore:3, timeHighRH:'1h/24h', status:'Low' },

  // Library (7 days)
  { building:'B', zone:'Library',  temperature:18.5, humidity:65, riskScore:4, timeHighRH:'2h/24h', status:'Medium' },
  { building:'B', zone:'Library',  temperature:19.2, humidity:68, riskScore:5, timeHighRH:'3h/24h', status:'Medium' },
  { building:'B', zone:'Library',  temperature:19.9, humidity:72, riskScore:7, timeHighRH:'4h/24h', status:'High' },
  { building:'B', zone:'Library',  temperature:20.1, humidity:81, riskScore:10, timeHighRH:'6h/24h', status:'High' },
  { building:'B', zone:'Library',  temperature:20.5, humidity:82, riskScore:11, timeHighRH:'8h/24h', status:'High' },
  { building:'B', zone:'Library',  temperature:19.7, humidity:78, riskScore:8, timeHighRH:'5h/24h', status:'High' },
  { building:'B', zone:'Library',  temperature:18.8, humidity:66, riskScore:4, timeHighRH:'2h/24h', status:'Medium' },
];

let chartLabels = [];
let tempData = [];
let rhData = [];

// On page load, populate everything
window.addEventListener('DOMContentLoaded', () => {
  updateDashboard();
  buildTable();
  buildChart();
});

// 1) Update the summary cards
function updateDashboard() {
  const buildingSet = new Set();
  let highCount = 0;
  let mediumCount = 0;
  let lowCount = 0;

  tableData.forEach(item => {
    buildingSet.add(item.building);
    const st = item.status.toLowerCase();
    if (st === 'high') highCount++;
    else if (st === 'medium') mediumCount++;
    else lowCount++;
  });

  document.getElementById('bldCount').textContent = buildingSet.size;
  document.getElementById('zoneCount').textContent = tableData.length;
  document.getElementById('highRiskCount').textContent = highCount;
  document.getElementById('cautionCount').textContent = mediumCount;
  document.getElementById('normalCount').textContent = lowCount;
}

// 2) Build the table rows
function buildTable() {
  const tbody = document.getElementById('zoneTableBody');
  tbody.innerHTML = '';

  tableData.forEach(item => {
    const tr = document.createElement('tr');

    // Building
    let td = document.createElement('td');
    td.textContent = item.building;
    tr.appendChild(td);

    // Zone
    td = document.createElement('td');
    td.textContent = item.zone;
    tr.appendChild(td);

    // Temperature
    td = document.createElement('td');
    td.textContent = item.temperature;
    tr.appendChild(td);

    // Humidity
    td = document.createElement('td');
    td.textContent = item.humidity;
    tr.appendChild(td);

    // Risk Score
    td = document.createElement('td');
    td.textContent = item.riskScore;
    tr.appendChild(td);

    // Time in High RH
    td = document.createElement('td');
    td.textContent = item.timeHighRH;
    tr.appendChild(td);

    // Status
    td = document.createElement('td');
    td.textContent = item.status;
    tr.appendChild(td);

    tbody.appendChild(tr);
  });
}

// 3) Build Chart (line for Temperature, bar for RH)
function buildChart() {
  // For demonstration, label each row as "Data 1, Data 2..." 
  chartLabels = tableData.map((_, i) => `Data ${i+1}`);
  tempData = tableData.map(d => d.temperature);
  rhData   = tableData.map(d => d.humidity);

  const ctx = document.getElementById('rhChart').getContext('2d');
  const data = {
    labels: chartLabels,
    datasets: [
      {
        type: 'line',
        label: 'Temperature (°C)',
        data: tempData,
        borderColor: 'blue',
        yAxisID: 'y'
      },
      {
        type: 'bar',
        label: 'Humidity (%)',
        data: rhData,
        backgroundColor: (ctx) => {
          const val = ctx.parsed.y;
          if (val < 60) return 'green';
          if (val < 70) return 'orange';
          return 'red';
        },
        yAxisID: 'y1'
      }
    ]
  };
  const config = {
    data,
    options: {
      scales: {
        y: {
          type: 'linear',
          position: 'left',
          title: { display: true, text: 'Temp (°C)' }
        },
        y1: {
          type: 'linear',
          position: 'right',
          title: { display: true, text: 'Humidity (%)' }
        }
      }
    }
  };
  new Chart(ctx, config);
}

// 4) Export CSV from tableData
document.getElementById('downloadCsv').addEventListener('click', () => {
  const rows = [
    ['Building','Zone','Temperature','Humidity','RiskScore','TimeHighRH','Status']
  ];
  tableData.forEach(item => {
    rows.push([
      item.building,
      item.zone,
      item.temperature,
      item.humidity,
      item.riskScore,
      item.timeHighRH,
      item.status
    ]);
  });

  let csvContent = '';
  rows.forEach(row => {
    csvContent += row.join(',') + '\\n';
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.setAttribute('download', 'MouldRiskData.csv');
  link.click();
});

// 5) Export PDF using pdfmake
document.getElementById('downloadPdf').addEventListener('click', () => {
  const pdfRows = [
    ['Building','Zone','Temperature','Humidity','RiskScore','TimeHighRH','Status']
  ];
  tableData.forEach(item => {
    pdfRows.push([
      item.building,
      item.zone,
      String(item.temperature),
      String(item.humidity),
      String(item.riskScore),
      item.timeHighRH,
      item.status
    ]);
  });

  const docDefinition = {
    content: [
      { text: 'Mould Risk Report', style: 'header' },
      {
        table: {
          body: pdfRows
        }
      }
    ],
    styles: {
      header: { fontSize: 16, bold: true }
    }
  };
  pdfMake.createPdf(docDefinition).download('MouldRiskReport.pdf');
});
</script>
</body>
</html>
