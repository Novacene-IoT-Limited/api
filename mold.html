<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mould Risk Dashboard (Exact Column Names)</title>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- pdfmake for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake/build/vfs_fonts.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    header { background: #f2f2f2; padding: 1rem; }
    .cards { display: flex; gap: 1rem; margin: 1rem; }
    .card { background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1; text-align: center; }
    h2 { margin: 0.5rem 0; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: left; }
    .btns { margin: 1rem; }
    .btns button { margin-right: 0.5rem; padding: 0.5rem 1rem; }
    #chartContainer { margin: 1rem; }
  </style>
</head>
<body>

<header>
  <h1>Mould Risk Dashboard</h1>
</header>

<!-- Top-level summary cards -->
<div class="cards">
  <div class="card">
    <h2>Records Found</h2>
    <p id="recordsCount">0</p>
  </div>
  <div class="card">
    <h2>High-RH Readings</h2>
    <p id="highRhCount">0</p>
  </div>
</div>

<!-- Data table -->
<div style="margin: 1rem;">
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Temperature (°C)</th>
        <th>Humidity (%)</th>
        <th>Risk Status</th>
      </tr>
    </thead>
    <tbody id="zoneTableBody">
      <!-- Populated dynamically from CSV -->
    </tbody>
  </table>
</div>

<!-- Chart container -->
<div id="chartContainer">
  <canvas id="rhChart"></canvas>
</div>

<!-- Buttons for exporting -->
<div class="btns">
  <button id="downloadCsv">Export CSV</button>
  <button id="downloadPdf">Export PDF</button>
</div>

<script>
// -----------------------------------------------------------------------
// 1) Your published Google Sheet CSV link (unchanged from your question):
// -----------------------------------------------------------------------
const GOOGLE_SHEET_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTtyaaD9UIdtuhO9BW1q6Mb4-26_jsidDU73HB1DE4Y8FE1tKSQxIAkLasrc3bT-0mvDy4ejjgTPJm1/pub?gid=0&single=true&output=csv';

// -----------------------------------------------------------------------
// 2) EXACT column names from your sheet (replace with your actual humidity col):
//    The user mentioned the temperature column is named:
//    "Temp Board - Elsys Co2 004 / temperature - A81758FFFE0CA9A1 - Temp Board"
//    If your humidity column is similarly named, provide it below:
// -----------------------------------------------------------------------
const EXACT_TIMESTAMP_HEADER = 'timestamp'; // Adjust if your sheet has a different name
const EXACT_TEMPERATURE_HEADER = 'Temp Board - Elsys Co2 004 / temperature - A81758FFFE0CA9A1 - Temp Board';
// Example guess for humidity column name:
const EXACT_HUMIDITY_HEADER = 'Temp Board - Elsys Co2 004 / humidity - A81758FFFE0CA9A1 - Temp Board';
// If your actual humidity column name is different, put it here.

let tableData = []; // array of { timestamp, temperature, humidity, riskStatus }

// 3) FETCH the CSV
fetch(GOOGLE_SHEET_CSV_URL)
  .then(response => response.text())
  .then(csv => {
    parseCsv(csv);
    updateDashboard();
    buildTable();
    buildChart();
  })
  .catch(err => console.error('Error fetching CSV:', err));

// 4) PARSE the CSV
function parseCsv(csv) {
  const lines = csv.split('\\n').filter(line => line.trim().length > 0);
  if (!lines.length) return;

  // Parse headers
  const headers = lines[0].split(',');

  // Find the index of each column
  const tsIndex = headers.indexOf(EXACT_TIMESTAMP_HEADER);
  const tempIndex = headers.indexOf(EXACT_TEMPERATURE_HEADER);
  const humIndex = headers.indexOf(EXACT_HUMIDITY_HEADER);

  if (tsIndex === -1) {
    console.warn('Could not find timestamp column:', EXACT_TIMESTAMP_HEADER);
  }
  if (tempIndex === -1) {
    console.warn('Could not find temperature column:', EXACT_TEMPERATURE_HEADER);
  }
  if (humIndex === -1) {
    console.warn('Could not find humidity column:', EXACT_HUMIDITY_HEADER);
  }

  // For each subsequent line
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i].split(',');
    // skip if row doesn't match number of columns
    if (row.length < headers.length) continue;

    // Extract data (or mark as null if not found)
    const tsVal = tsIndex > -1 ? row[tsIndex] : '';
    const tempValRaw = tempIndex > -1 ? row[tempIndex] : '';
    const humValRaw = humIndex > -1 ? row[humIndex] : '';

    const temperature = parseFloat(tempValRaw);
    const humidity = parseFloat(humValRaw);

    // Simple risk logic: if humidity > 70 => High, between 60-70 => Medium, else Low
    let riskStatus = 'Low';
    if (!isNaN(humidity)) {
      if (humidity >= 70) {
        riskStatus = 'High';
      } else if (humidity >= 60) {
        riskStatus = 'Medium';
      }
    }

    tableData.push({
      timestamp: tsVal,
      temperature: !isNaN(temperature) ? temperature : null,
      humidity: !isNaN(humidity) ? humidity : null,
      riskStatus
    });
  }
}

// 5) UPDATE DASHBOARD COUNTERS
function updateDashboard() {
  document.getElementById('recordsCount').innerText = tableData.length;

  // Count how many entries are "High"
  let highCount = 0;
  tableData.forEach(d => {
    if (d.riskStatus === 'High') {
      highCount++;
    }
  });
  document.getElementById('highRhCount').innerText = highCount;
}

// 6) BUILD THE TABLE
function buildTable() {
  const tbody = document.getElementById('zoneTableBody');
  tbody.innerHTML = '';

  tableData.forEach(item => {
    const tr = document.createElement('tr');

    const tdTime = document.createElement('td');
    tdTime.textContent = item.timestamp;
    tr.appendChild(tdTime);

    const tdTemp = document.createElement('td');
    tdTemp.textContent = item.temperature !== null ? item.temperature.toFixed(1) : 'N/A';
    tr.appendChild(tdTemp);

    const tdHum = document.createElement('td');
    tdHum.textContent = item.humidity !== null ? item.humidity.toFixed(1) : 'N/A';
    tr.appendChild(tdHum);

    const tdRisk = document.createElement('td');
    tdRisk.textContent = item.riskStatus;
    tr.appendChild(tdRisk);

    tbody.appendChild(tr);
  });
}

// 7) BUILD THE CHART
function buildChart() {
  const ctx = document.getElementById('rhChart').getContext('2d');

  // We'll label each entry by its timestamp (be careful if you have thousands of data points).
  const labels = tableData.map(d => d.timestamp);

  // Temperature line
  const tempValues = tableData.map(d => d.temperature);
  // Humidity bar
  const humValues = tableData.map(d => d.humidity);

  new Chart(ctx, {
    data: {
      labels: labels,
      datasets: [
        {
          type: 'line',
          label: 'Temperature (°C)',
          data: tempValues,
          borderColor: 'blue',
          backgroundColor: 'blue',
          yAxisID: 'y'
        },
        {
          type: 'bar',
          label: 'Humidity (%)',
          data: humValues,
          backgroundColor: function(context) {
            const val = context.parsed.y;
            if (isNaN(val)) return 'grey';
            if (val < 60) return 'green';
            if (val < 70) return 'orange';
            return 'red';
          },
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      scales: {
        y: {
          type: 'linear',
          position: 'left',
          title: { display: true, text: 'Temperature (°C)' }
        },
        y1: {
          type: 'linear',
          position: 'right',
          title: { display: true, text: 'Humidity (%)' }
        }
      },
      responsive: true
    }
  });
}

// 8) EXPORT CSV
document.getElementById('downloadCsv').addEventListener('click', () => {
  const rows = [['Timestamp','Temperature','Humidity','Risk Status']];
  tableData.forEach(item => {
    rows.push([
      item.timestamp,
      item.temperature !== null ? String(item.temperature.toFixed(1)) : 'N/A',
      item.humidity !== null ? String(item.humidity.toFixed(1)) : 'N/A',
      item.riskStatus
    ]);
  });
  let csvContent = '';
  rows.forEach(row => {
    csvContent += row.join(',') + '\\n';
  });
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', 'DashboardData.csv');
  link.click();
});

// 9) EXPORT PDF
document.getElementById('downloadPdf').addEventListener('click', () => {
  const bodyRows = [
    ['Timestamp','Temperature','Humidity','Risk Status']
  ];
  tableData.forEach(item => {
    bodyRows.push([
      item.timestamp,
      item.temperature !== null ? item.temperature.toFixed(1) : 'N/A',
      item.humidity !== null ? item.humidity.toFixed(1) : 'N/A',
      item.riskStatus
    ]);
  });

  const docDefinition = {
    content: [
      { text: 'Mould Risk Report', style: 'header' },
      '',
      {
        table: {
          body: bodyRows
        }
      }
    ],
    styles: {
      header: { fontSize: 16, bold: true }
    }
  };
  pdfMake.createPdf(docDefinition).download('DashboardReport.pdf');
});
</script>

</body>
</html>
